#---------------------------------------------------------#
# Deterministic SIR epidemic model in a closed population #
#---------------------------------------------------------#

equationsSIR <- function(time, variables, parameters, ...) {
  with(append(as.list(variables, parameters)), {
    betaSINq <- beta * ((S * I) / N^q)

    dS <- muB * N
    - muB * S
    - betaSINq

    dI <- betaSINq
    - gamma * I
    - muD * I

    dR <- gamma * I
    - muD * R

    dN <- dS + dI + dR
    list(c(dS, dI, dR, dN), q)
  })
}

solveSIR <- function(beta = 0.001, gamma = 0.1, muB = 0, muD = 0, population = 500,
                      susceptible = 499, infected = 1, recovered = 0,timesteps = 50,
                      q = 0, vitalStatisticsSelect = FALSE)
{
  variables <- c(susceptible, infected, recovered, population)
  names(variables) <- c("S", "I", "R", "N")
  if(!vitalStatisticsSelect) {
    muB <- 0
    muD <- 0
  }
  parameters <- c(beta, gamma, muB, muD)
  names(parameters) <- c("beta", "gamma", "muB", "muD")

  deSolve::lsoda(
    variables, seq(0, timesteps, by = 1),
    equationsSIR, parameters, q
  ) |>
    as.data.frame()
}

plotTheme <- ggplot2::theme(
  axis.line = ggplot2::element_line(color = "black"),
  axis.text = ggplot2::element_text(size = 14),
  axis.title.x = ggplot2::element_text(size = 16, face = "bold"),
  axis.title.y = ggplot2::element_text(size = 16, face = "bold"),
  plot.title = ggplot2::element_text(size = 22, face = "bold"),
  legend.position = "bottom"
)

# Plot
plotSIR <- function(model)
{
  ggplot2::ggplot(model, ggplot2::aes(x = time)) +
    plotTheme +

    ggplot2::labs(title = "SIRS Epidemic Model", y = "Number of People",
                  x = "Time") +
    ggplot2::scale_x_continuous(expand = c(0, 0)) +
    ggplot2::scale_y_continuous(expand = c(0, 0)) +
    ggplot2::geom_line(ggplot2::aes(y = S, color = "Blue"), linewidth = 1.5) +
    ggplot2::geom_line(ggplot2::aes(y = I, color = "Red"), linewidth = 1.5) +
    ggplot2::geom_line(ggplot2::aes(y = R, color = "Green"), linewidth = 1.5) +

    ggplot2::scale_color_identity(
      name = "SIR", breaks = c("Blue", "Red", "Green"),
      labels = c("Susceptible", "Infected", "Recovered"), guide = "legend"
    )
}

# plot phase plane
plotPhasePlaneSIR <- function(model)
{
  ggplot2::ggplot(model, ggplot2::aes(x = S))+

    ggplot2::geom_line(ggplot2::aes(y = I, color = "Blue"), linewidth = 1.5) +
    plotTheme +
    ggplot2::ggtitle("SI Phase Plane") +
    ggplot2::theme(plot.title = ggplot2::element_text(size = 22, face = "bold")) +
    ggplot2::ylab("Infected (I)") +
    ggplot2::scale_x_continuous(expand = c(0, 0)) +
    ggplot2::scale_y_continuous(expand = c(0, 0)) +
    ggplot2::xlab("Susceptible (S)") +
    ggplot2::scale_color_identity(
      name = "SIR", breaks = c("Blue", "Red", "Green"),
      labels = c("Susceptible", "Infected", "Recovered"), guide = "legend"
    )
}
